# ,Масса бесполезных фактов об оптимизации V8/NodeJS (часть 1),,

Мы снова в деле после долгого отсутствия. Поводом послужила моя попытка разогнать Javascript для одного из конкурсов и в процессе разгона, я понял довольно много о том, где есть узкие места в коде. Понятно, конечно что разгон оптимизаторство не сильно хорошая идея в JS, по хорошему все оптимизации должен делать JIT максимально интеллектуальным способом, да и самые лучшие разгоны от смены бизнес логики/алгоритма, а не от смены пары выражений. Тем не менее мне было очень интересно поковыряться и посравнивать, чтобы что-то себе обосновать я заодно пытался прочесть исходники V8, но к сожалению, мало что осмысленного сумел выудить, как именно работает JIT, я так и не догнал, но провел анализ на уровне последствий. Наверное это будет в несколько частей, поскольку довольно много всякого раскопал, ваши комментарии приветствуются :)

#### Switch

Плохо работает не с Integer: switch преобразуется таким образом в набор if/else. При большом количестве case'ов(я так думаю где-то от 10 case'ов среднее по switch'у будет хуже чем объект) лучше преобразовать этот набор в объект, где выборка происходит за константное время. В случае с Integer все гораздо быстрее. Как точно я сказать не могу, по исходному коду V8, сначала идет typecheck, а затем уже сравнение. Однако чисто по скорости выходит, что судя по всему происходит BTree внутри, если там Integer.

Link: [Benchmark][0].

Результаты бенчмарка:

Switch со строковыми 4мя case'ами(сразу взял худший случай):   
**switch 4 x 33,643,664 ops/sec ±4.56% (84 runs sampled)** 

Объект с 4мя property:   
**obj 4 x 29,894,294 ops/sec ±1.33% (97 runs sampled)**   
Чуть хуже результат.

Switch со строковыми 24мя case'ами, худший/лучший случай:   
**switch 24 best x 57,746,772 ops/sec ±3.34% (65 runs sampled)**   
**switch 24 worst x 9,067,273 ops/sec ±4.27% (82 runs sampled)**   
Видно, что очень сильно разнятся эти случаи по скорости.

Объект с 24мя property:   
**obj 24 x 33,022,036 ops/sec ±0.78% (99 runs sampled)**   
Вот тут нету разницы между 4 property или 24 property.

Switch 24 case'а все integer, худший случай/лучший случай:   
**switch int best x 51,757,926 ops/sec ±3.99% (90 runs sampled)
switch int worst x 47,792,792 ops/sec ±9.16% (82 runs sampled)**   
По скорости тут не очень большая разница в скорости проверки.

Объект с 4мя property и ключи Integer:   
**obj int x 22,696,294 ops/sec ±1.04% (99 runs sampled)**   
Тут тратится дополнительное время на преобразование из Integer в String и только потом берется по ключу.

Все результаты конечно проводились не в ваакуме. Чтобы провести аналогичный скачайте себе файл из pastebin и поставить nodejs, а также модуль **benchmark** этой командой: 

`npm install benchmark`

#### Динамическое создание функций

Фактически в javascript'е есть 3 способа создания функции:   
**1\.** Первый самый обычный способ через function name(){} или var b = function(){}, статический способ, который будет обработан компилятором самым лучшим образом;   
**2\.** Второй это вызвать тот же самый статический код через eval, но это страдает от того что он не будет отоптимизирован еще до применения и судя по тестам в дальнейшем также не будет оптимизирован.   
**3\.** Создать функцию через **new Function**. Последним аргументом будет телом функции, а те что идут до должны являться строками, которые будут обозначать будущие аргументы. Например:   
`var double = new Function('num','return num*2;');`   
равнозначно
`var double = function(num){ return num*2; }`

Link: [Benchmark][1].

Результаты:

**static function x 60,944,355 ops/sec ±2.69% (81 runs sampled)   
eval function x 5,327,642 ops/sec ±2.44% (86 runs sampled)   
new Function x 40,244,307 ops/sec ±2.06% (89 runs sampled)**

По результатам сразу видно, что **eval** совсем отстойно отрабатывает. А вот **new Function** работает всего в 1.5 раза медленее, чем статическая функция, хотя в идеале все должно работать с одинаковой скоростью, но видимо v8 все таки еще не умеет до конца разгонять динамические функции.


[0]: http://pastebin.com/x9XGMGfT
[1]: http://pastebin.com/XpQAHyRq